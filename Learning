<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Hồ Chí Minh - Hành trình cứu nước</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;900&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --red-primary: #d63031;
      --red-dark: #b71c1c;
      --gold: #fbc531;
      --bg-color: #f5f6fa;
      --text-color: #2f3640;
      --green: #44bd32;
      --gray: #718093;
      --card-shadow: 0 10px 20px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0;
      font-family: 'Be Vietnam Pro', sans-serif;
      background-color: var(--bg-color);
      height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-color);
    }

    #app {
      width: 100%;
      max-width: 900px;
      height: 100%;
      max-height: 100vh;
      position: relative;
      background: white;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    @media (min-width: 900px) {
      #app {
        height: 90vh;
        border-radius: 20px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.15);
      }
    }

    /* --- VIEW MANAGEMENT --- */
    .view-section {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease, transform 0.4s ease;
      background: white;
      z-index: 1;
    }
    
    .view-section.active {
      opacity: 1;
      pointer-events: all;
      z-index: 10;
      transform: scale(1);
    }
    
    .view-section.hidden-left { transform: translateX(-30px); opacity: 0; }
    .view-section.hidden-right { transform: translateX(30px); opacity: 0; }

    /* --- PAGE 1: INTRO --- */
    #view-intro {
      background: linear-gradient(135deg, var(--red-primary), #800000);
      color: white;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 30px;
    }
    
    .intro-decor { font-size: 5rem; color: var(--gold); margin-bottom: 20px; animation: float 3s infinite ease-in-out; }
    
    h1.main-title {
      font-family: 'Playfair Display', serif;
      font-size: 3.5rem;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 2px;
      text-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .start-btn {
      margin-top: 40px;
      background: var(--gold);
      color: var(--red-dark);
      border: none;
      padding: 15px 50px;
      font-size: 1.3rem;
      font-weight: 800;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
      transition: transform 0.2s;
    }
    .start-btn:active { transform: scale(0.95); }

    /* --- PAGE 2: FILE GRID (Được nâng cấp) --- */
    #view-files { background: #f1f2f6; }
    
    .top-header {
      padding: 20px 30px;
      background: white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 5;
    }
    .top-title { font-weight: 800; font-size: 1.2rem; color: var(--red-primary); display: flex; align-items: center; gap: 10px; }
    
    .files-container {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 20px;
      align-content: start;
    }

    /* Style cho từng ô hồ sơ */
    .file-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      position: relative;
      cursor: pointer;
      box-shadow: var(--card-shadow);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      border-bottom: 4px solid transparent;
      height: 140px;
      justify-content: center;
    }

    .file-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.12); }

    .file-badge {
      position: absolute; top: 10px; right: 10px;
      font-size: 0.8rem; font-weight: 900; color: #dfe4ea;
    }
    
    .file-icon-box {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: var(--gold);
      filter: drop-shadow(0 4px 2px rgba(0,0,0,0.1));
    }
    
    .file-label { font-size: 0.9rem; font-weight: 700; color: var(--gray); }

    /* Trạng thái */
    .file-card.status-correct { border-bottom-color: var(--green); background: #f0fff4; }
    .file-card.status-correct .file-icon-box { color: var(--green); }
    .file-card.status-correct .file-label { color: var(--green); }
    
    .file-card.status-wrong { border-bottom-color: var(--red-primary); background: #fff5f5; }
    .file-card.status-wrong .file-icon-box { color: var(--red-primary); }
    .file-card.status-wrong .file-label { color: var(--red-primary); }

    /* --- PAGE 3: QUESTION --- */
    #view-question { background: white; }
    
    .q-nav {
      padding: 15px 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
    }
    .btn-back { border: none; background: none; font-size: 1.1rem; color: var(--gray); cursor: pointer; }
    .q-number { font-weight: 800; color: var(--red-primary); background: #ffeaa7; padding: 5px 15px; border-radius: 20px; }

    .q-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px 30px;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
    }

    .q-content {
      font-family: 'Playfair Display', serif;
      font-size: 1.4rem;
      margin-bottom: 30px;
      line-height: 1.5;
      color: #2c3e50;
    }

    /* --- MCQ STYLES --- */
    .mcq-options { display: flex; flex-direction: column; gap: 15px; }
    .mcq-btn {
      text-align: left;
      padding: 18px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 1rem;
      cursor: pointer;
      transition: 0.2s;
      color: #555;
    }
    .mcq-btn strong { margin-right: 10px; color: var(--red-primary); }
    .mcq-btn:hover:not(:disabled) { border-color: #bdc3c7; background: #f9f9f9; }
    .mcq-btn.selected { border-color: var(--red-primary); background: #fff1f1; color: var(--red-primary); font-weight: 600; }
    
    /* Result states MCQ */
    .mcq-btn.res-correct { background: #d4efdf !important; border-color: var(--green) !important; color: #145a32 !important; }
    .mcq-btn.res-wrong { background: #fadbd8 !important; border-color: var(--red-primary) !important; opacity: 0.6; }

    /* --- CLUSTER TRUE/FALSE STYLES --- */
    .cluster-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 10px;
    }
    
    .cluster-row {
      background: #f8f9fa;
      border-radius: 8px;
      transition: 0.2s;
    }
    
    /* Cột nội dung text */
    .cluster-text {
      padding: 15px;
      font-weight: 500;
      border: 1px solid #eee;
      border-right: none;
      border-radius: 8px 0 0 8px;
    }

    /* Cột nút bấm */
    .cluster-actions {
      width: 140px;
      padding: 5px;
      border: 1px solid #eee;
      border-left: none;
      border-radius: 0 8px 8px 0;
      background: white;
      vertical-align: middle;
      text-align: center;
    }

    .tf-switch-container {
      display: flex;
      gap: 5px;
      justify-content: center;
    }

    .btn-tf {
      flex: 1;
      padding: 8px 0;
      font-size: 0.85rem;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 4px;
      font-weight: 600;
      transition: all 0.2s;
    }

    /* Màu khi chọn - Sửa lỗi: Cần thuộc tính data-val để CSS nhận diện */
    .btn-tf[data-val="true"]:hover { background: #e8f5e9; border-color: var(--green); }
    .btn-tf[data-val="false"]:hover { background: #ffebee; border-color: var(--red-primary); }

    .btn-tf.active[data-val="true"] { background: var(--green); color: white; border-color: var(--green); }
    .btn-tf.active[data-val="false"] { background: var(--red-primary); color: white; border-color: var(--red-primary); }

    /* Kết quả Cluster */
    .cluster-row.row-correct .cluster-text { background: #eafaf1; border-color: var(--green); color: #145a32; }
    .cluster-row.row-wrong .cluster-text { background: #fdedec; border-color: var(--red-primary); color: #922b21; }
    
    /* Hiển thị đáp án đúng nhỏ bên cạnh nếu sai */
    .correct-hint { font-size: 0.75rem; display: block; margin-top: 4px; font-weight: 800; }

    /* --- BOTTOM BAR --- */
    .q-footer {
      padding: 20px;
      background: white;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }
    
    .action-btn {
      padding: 12px 25px;
      border-radius: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }
    .btn-check { background: var(--red-primary); color: white; opacity: 0.5; pointer-events: none; }
    .btn-check.ready { opacity: 1; pointer-events: all; }
    .btn-show-ans { background: white; border: 2px solid var(--gold); color: #b7950b; display: none; }

    /* --- PAGE 4: RESULT --- */
    #view-result { text-align: center; justify-content: center; background: white; }
    .score-circle {
      width: 150px; height: 150px;
      background: var(--red-primary);
      color: white;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 3rem;
      font-weight: 800;
      margin: 0 auto 30px;
      box-shadow: 0 15px 30px rgba(214, 48, 49, 0.4);
      font-family: 'Playfair Display', serif;
    }
    
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }

  </style>
</head>
<body>

<div id="app">

  <div id="view-intro" class="view-section active">
    <div class="intro-decor"><i class="fa-solid fa-star"></i></div>
    <h1 class="main-title">Hồ Chí Minh</h1>
    <h2 style="font-weight: 400; opacity: 0.9;">Anh hùng giải phóng dân tộc</h2>
    <p style="max-width: 500px; margin: 30px auto; line-height: 1.6; opacity: 0.9;">
      Người chơi chọn một tệp bất kỳ và trả lời câu hỏi tương ứng.<br>
      Bao gồm trắc nghiệm và các câu hỏi nhận định Đúng/Sai.
    </p>
    <button class="start-btn" onclick="game.start()">Mở Kho Tư Liệu</button>
  </div>

  <div id="view-files" class="view-section hidden-right">
    <div class="top-header">
      <div class="top-title">
        <i class="fa-solid fa-box-archive"></i> KHO TƯ LIỆU
      </div>
      <div style="font-size:0.9rem; font-weight:600; color:var(--gray)">
        Hoàn thành: <span id="progress-text" style="color:var(--text-color)">0/29</span>
      </div>
    </div>
    <div class="files-container" id="grid-container">
      </div>
  </div>

  <div id="view-question" class="view-section hidden-right">
    <div class="q-nav">
      <button class="btn-back" onclick="game.backToGrid()"><i class="fa-solid fa-arrow-left"></i> Quay lại</button>
      <div class="q-number">HỒ SƠ <span id="q-idx-disp">01</span></div>
    </div>

    <div class="q-body">
      <div class="q-content" id="q-text">Nội dung câu hỏi...</div>
      
      <div id="mcq-area" class="mcq-options" style="display:none"></div>

      <table id="cluster-area" class="cluster-table" style="display:none">
        </table>
    </div>

    <div class="q-footer">
      <button class="action-btn btn-show-ans" id="btn-reveal">
        <i class="fa-regular fa-eye"></i> Xem đáp án
      </button>
      <button class="action-btn btn-check" id="btn-submit">
        Kiểm tra
      </button>
    </div>
  </div>

  <div id="view-result" class="view-section hidden-right">
    <div class="score-circle" id="final-score">29/29</div>
    <h2 style="font-family:'Playfair Display'; font-size:2rem; margin:0">Hoàn thành nhiệm vụ!</h2>
    <p style="color:var(--gray); margin-bottom: 30px;">Bạn đã giải mã toàn bộ hồ sơ mật.</p>
    <button class="start-btn" onclick="location.reload()" style="font-size:1rem; padding:12px 30px; margin:0;">
      <i class="fa-solid fa-rotate-right"></i> Làm lại từ đầu
    </button>
  </div>

</div>

<script>
// --- CẤU TRÚC DỮ LIỆU ---
const db = [
  // 24 Câu Trắc Nghiệm (MCQ)
  { type:'mcq', q:'Hồ Chí Minh ra đi tìm đường cứu nước vào năm nào?', a:['1905','1911','1920','1930'], correct:1 },
  { type:'mcq', q:'Bến cảng nơi Người ra đi tìm đường cứu nước là?', a:['Cảng Sài Gòn (Bến Nhà Rồng)','Cảng Hải Phòng','Cảng Đà Nẵng','Cảng Vinh'], correct:0 },
  { type:'mcq', q:'Khoảng thời gian Hồ Chí Minh tìm ra con đường cứu nước đúng đắn là?', a:['1911–1916','1911–1920','1920–1925','1925–1930'], correct:1 },
  { type:'mcq', q:'Sự kiện nào đã giúp Người tìm thấy con đường giải phóng cho dân tộc?', a:['Cách mạng Tân Hợi','Cách mạng Pháp 1789','Cách mạng Tháng Mười Nga 1917','Chiến tranh thế giới thứ nhất'], correct:2 },
  { type:'mcq', q:'Năm 1920, tại Pháp, Hồ Chí Minh đã tham gia sáng lập tổ chức nào?', a:['Quốc tế Cộng sản','Đảng Cộng sản Pháp','Đảng Lao động Việt Nam','Mặt trận Việt Minh'], correct:1 },
  { type:'mcq', q:'Vai trò nổi bật nhất của Hồ Chí Minh trong Hội nghị thành lập Đảng (1930) là?', a:['Chủ trì hội nghị hợp nhất','Soạn thảo Cương lĩnh đầu tiên','Thống nhất tư tưởng','Tất cả các ý trên'], correct:3 },
  { type:'mcq', q:'Cách mạng Tháng Tám năm 1945 thắng lợi dưới sự lãnh đạo trực tiếp của ai?', a:['Trần Phú','Lê Duẩn','Hồ Chí Minh','Phạm Văn Đồng'], correct:2 },
  { type:'mcq', q:'Hồ Chí Minh đọc Tuyên ngôn Độc lập vào ngày nào?', a:['19/8/1945','25/8/1945','1/9/1945','2/9/1945'], correct:3 },
  { type:'mcq', q:'Sau Cách mạng Tháng Tám, nhiệm vụ nào KHÔNG phải là nhiệm vụ cấp bách?', a:['Diệt giặc đói','Diệt giặc dốt','Diệt giặc ngoại xâm','Công nghiệp hóa hiện đại hóa'], correct:3 },
  { type:'mcq', q:'Đường lối chiến lược “vừa kháng chiến vừa kiến quốc” do ai đề ra?', a:['Trường Chinh','Hồ Chí Minh','Võ Nguyên Giáp','Phạm Văn Đồng'], correct:1 },
  { type:'mcq', q:'Giai đoạn Hồ Chí Minh lãnh đạo kháng chiến chống thực dân Pháp là?', a:['1930–1945','1945–1954','1954–1969','1920–1930'], correct:1 },
  { type:'mcq', q:'Giai đoạn Hồ Chí Minh lãnh đạo kháng chiến chống Mỹ cứu nước là?', a:['1945–1954','1954–1969','1930–1945','1969–1975'], correct:1 },
  { type:'mcq', q:'Chiến thắng Điện Biên Phủ (1954) diễn ra dưới sự chỉ đạo tối cao của ai?', a:['Hồ Chí Minh','Lê Duẩn','Nguyễn Ái Quốc','Trường Chinh'], correct:0 },
  { type:'mcq', q:'Hồ Chí Minh được UNESCO ra nghị quyết tôn vinh vào năm nào?', a:['1975','1980','1987','1990'], correct:2 },
  { type:'mcq', q:'UNESCO tôn vinh Người với danh hiệu gì?', a:['Nhà văn hóa kiệt xuất','Anh hùng giải phóng dân tộc và doanh nhân văn hóa thế giới','Nhà tư tưởng vĩ đại','Nhà chính trị lỗi lạc'], correct:1 },
  { type:'mcq', q:'Chủ tịch Hồ Chí Minh qua đời vào năm nào?', a:['1968','1969','1970','1975'], correct:1 },
  { type:'mcq', q:'Nơi ở và làm việc của Người trong những năm cuối đời (1958-1969) là?', a:['Hang Pác Bó','ATK Định Hóa','Nhà sàn (Phủ Chủ tịch)','Lán Nà Nưa'], correct:2 },
  { type:'mcq', q:'Tư tưởng xuyên suốt của Hồ Chí Minh về độc lập dân tộc?', a:['Độc lập dân tộc gắn liền với dân chủ','Độc lập gắn với tự do, hạnh phúc','Chỉ cần độc lập về chính trị','Phát triển kinh tế tư bản'], correct:1 },
  { type:'mcq', q:'Câu nói “Không có gì quý hơn độc lập, tự do” được Người kêu gọi vào năm nào?', a:['1945','1954','1966','1969'], correct:2 },
  { type:'mcq', q:'Khi lãnh đạo chống Mỹ, Người đưa ra chủ trương?', a:['Quyết chiến chiến lược','Cải cách ruộng đất','Thống nhất nước nhà','Công – tư hợp doanh'], correct:2 },
  { type:'mcq', q:'Tổ chức do Hồ Chí Minh thành lập năm 1941?', a:['Việt Minh','Thanh niên CMĐ','Hội Liên hiệp các dân tộc bị áp bức','Đảng Lao động'], correct:0 },
  { type:'mcq', q:'“Tuyên ngôn Độc lập”, trích dẫn văn kiện của quốc gia nào?', a:['Pháp ','Mỹ ','Anh ','Nga'], correct:1 },
  { type:'mcq', q:'Mục tiêu lớn nhất của Người trong suốt đời hoạt động Cách Mạng?', a:['Xây dựng chủ nghĩa xã hội','Tự do cho mỗi người dân','Độc lập cho dân tộc','Phát triển kinh tế'], correct:2 },
  { type:'mcq', q:'Câu nào nói về phẩm chất của Hồ Chí Minh?', a:['Khiêm tốn, giản dị','Ham quyền lực','Lỗi sống xa hoa','Độc đoán'], correct:0 },

  // 5 Câu Chùm Đúng/Sai (Cluster)
  { 
    type: 'cluster',
    q: 'Hành trình tìm đườnh cứu nước (1911-1920):',
    items: [
      { text: 'Năm 1911, Người rời bến Nhà Rồng.', val: true },
      { text: 'Người sang Nhật để học quân sự.', val: false },
      { text: 'Người tìm hiểu nhiều con đường cứu nước khác nhau.', val: true },
      { text: 'Người chọn con đường bạo động phong kiến.', val: false }
    ]
  },
  { 
    type: 'cluster',
    q: 'Cách mạng Tháng Tám 1945:',
    items: [
      { text: 'Hồ Chí Minh lãnh đạo Tổng khởi nghĩa.', val: true },
      { text: 'Người đọc Tuyên ngôn Độc lập ngày 2/9/1945.', val: true },
      { text: 'Thắng lợi này chủ yếu do Pháp hỗ trợ.', val: false },
      { text: 'Sau CMT8, nước ta không gặp khó khăn nào.', val: false }
    ]
  },
  { 
    type: 'cluster',
    q: 'Kháng chiến chống Pháp (1945–1954):',
    items: [
      { text: 'Hồ Chí Minh đề ra đường lối “vừa kháng chiến vừa kiến quốc”.', val: true },
      { text: 'Người trực tiếp cầm quân đánh Điện Biên Phủ.', val: false },
      { text: 'Người lãnh đạo toàn dân kháng chiến trường kỳ.', val: true },
      { text: 'Người chủ trương đầu hàng Pháp để giữ lực lượng.', val: false }
    ]
  },
  { 
    type: 'cluster',
    q: 'Kháng chiến chống Mỹ – Cứu nước (1954–1969):',
    items: [
      { text: 'Người khẳng định mục tiêu: thống nhất nước nhà.', val: true },
      { text: 'Người trực tiếp ra trận ở miền Nam.', val: false },
      { text: 'Người quan tâm đến hậu phương miền Bắc xã hội chủ nghĩa.', val: true },
      { text: 'Người mất năm 1979.', val: false }
    ]
  },
  { 
    type: 'cluster',
    q: 'Thành lập Đảng Cộng sản Việt Nam',
    items: [
      { text: 'Hồ Chí Minh chủ trì Hội nghị hợp nhất các tổ chức cộng sản.', val: true },
      { text: 'Người soạn thảo Cương lĩnh chính trị đầu tiên của Đảng.', val: true },
      { text: 'Đảng Cộng sản Việt Nam thành lập năm 1940', val: false },
      { text: 'Đảng ra đời là tất yếu, không cần vai trò của Hồ Chí Minh.', val: false }
    ]
  }
];

const game = {
  status: [], // null = chưa làm, true = đúng, false = sai
  currentIdx: -1,
  
  // State tạm thời cho câu hỏi hiện tại
  tempMcq: -1,
  tempCluster: [null, null, null, null],

  start() {
    this.status = new Array(db.length).fill(null);
    this.renderGrid();
    this.switchView('view-files');
  },

  switchView(id) {
    document.querySelectorAll('.view-section').forEach(el => {
      el.classList.remove('active');
      el.classList.add('hidden-right');
    });
    const target = document.getElementById(id);
    target.classList.remove('hidden-right');
    setTimeout(() => target.classList.add('active'), 50);
  },

  renderGrid() {
    const grid = document.getElementById('grid-container');
    grid.innerHTML = '';
    const doneCount = this.status.filter(x => x !== null).length;
    document.getElementById('progress-text').innerText = `${doneCount}/${db.length}`;

    if(doneCount === db.length) {
       // logic finish
    }

    db.forEach((item, idx) => {
      const st = this.status[idx];
      const el = document.createElement('div');
      
      let cls = 'file-card';
      let icon = '<i class="fa-solid fa-folder"></i>';
      let badge = '';

      if (st === true) {
        cls += ' status-correct';
        icon = '<i class="fa-regular fa-folder-open"></i>';
        badge = '<i class="fa-solid fa-check" style="color:var(--green)"></i>';
      } else if (st === false) {
        cls += ' status-wrong';
        icon = '<i class="fa-regular fa-folder-open"></i>';
        badge = '<i class="fa-solid fa-xmark" style="color:var(--red-primary)"></i>';
      }

      el.className = cls;
      el.innerHTML = `
        <div class="file-badge">${badge}</div>
        <div class="file-icon-box">${icon}</div>
        <div class="file-label">Hồ sơ ${idx+1}</div>
      `;

      if (st === null) {
        el.onclick = () => this.openQuestion(idx);
      } else {
        el.style.opacity = '0.8';
        el.style.cursor = 'default';
      }
      grid.appendChild(el);
    });
  },

  backToGrid() {
    const doneCount = this.status.filter(x => x !== null).length;
    if (doneCount === db.length) {
      this.showResult();
    } else {
      this.renderGrid();
      this.switchView('view-files');
    }
  },

  showResult() {
    const correct = this.status.filter(x => x === true).length;
    document.getElementById('final-score').innerText = `${correct}/${db.length}`;
    this.switchView('view-result');
  },

  // --- QUESTION LOGIC ---
  openQuestion(idx) {
    this.currentIdx = idx;
    const data = db[idx];
    
    // Reset UI
    document.getElementById('q-idx-disp').innerText = (idx + 1).toString().padStart(2,'0');
    document.getElementById('q-text').innerText = data.q;
    document.getElementById('btn-reveal').style.display = 'none';
    
    const btnSub = document.getElementById('btn-submit');
    btnSub.innerText = 'Kiểm tra';
    btnSub.className = 'action-btn btn-check';
    btnSub.style.display = 'block';
    btnSub.style.background = 'var(--red-primary)'; // Reset màu nút kiểm tra
    btnSub.onclick = () => this.submitAnswer();

    // Reset Temp State
    this.tempMcq = -1;
    this.tempCluster = [null, null, null, null];

    const mcqArea = document.getElementById('mcq-area');
    const cluArea = document.getElementById('cluster-area');

    if (data.type === 'mcq') {
      mcqArea.style.display = 'flex';
      cluArea.style.display = 'none';
      this.renderMCQ(data);
    } else {
      mcqArea.style.display = 'none';
      cluArea.style.display = 'table';
      this.renderCluster(data);
    }
    
    this.switchView('view-question');
  },

  renderMCQ(data) {
    const box = document.getElementById('mcq-area');
    box.innerHTML = '';
    data.a.forEach((ans, i) => {
      const btn = document.createElement('div');
      btn.className = 'mcq-btn';
      btn.innerHTML = `<strong>${String.fromCharCode(65+i)}.</strong> ${ans}`;
      btn.onclick = () => {
        if (document.getElementById('btn-submit').innerText !== 'Kiểm tra') return;
        
        this.tempMcq = i;
        document.querySelectorAll('.mcq-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById('btn-submit').classList.add('ready');
      };
      box.appendChild(btn);
    });
  },

  renderCluster(data) {
    const table = document.getElementById('cluster-area');
    table.innerHTML = '';
    
    data.items.forEach((item, i) => {
      const row = document.createElement('tr');
      row.className = 'cluster-row';
      row.id = `c-row-${i}`;
      
      // SỬA LỖI TẠI ĐÂY: Thêm data-val="false" và data-val="true" vào thẻ button
      row.innerHTML = `
        <td class="cluster-text">
          <span style="color:var(--red-primary); font-weight:700; margin-right:5px;">${String.fromCharCode(97+i)}.</span> 
          ${item.text}
          <div class="correct-hint" id="hint-${i}" style="display:none"></div>
        </td>
        <td class="cluster-actions">
           <div class="tf-switch-container">
             <button class="btn-tf" data-val="false" id="btn-sai-${i}" onclick="game.selectCluster(${i}, false)">Sai</button>
             <button class="btn-tf" data-val="true" id="btn-dung-${i}" onclick="game.selectCluster(${i}, true)">Đúng</button>
           </div>
        </td>
      `;
      table.appendChild(row);
    });
  },

  selectCluster(rowIdx, val) {
    if (document.getElementById('btn-submit').innerText !== 'Kiểm tra') return;

    this.tempCluster[rowIdx] = val;
    
    // Update UI nút
    const btnSai = document.getElementById(`btn-sai-${rowIdx}`);
    const btnDung = document.getElementById(`btn-dung-${rowIdx}`);
    
    btnSai.classList.remove('active');
    btnDung.classList.remove('active');
    
    if (val === false) btnSai.classList.add('active');
    else btnDung.classList.add('active');

    // Check xem đủ 4 câu chưa
    const filled = this.tempCluster.every(x => x !== null);
    const btnSub = document.getElementById('btn-submit');
    if (filled) btnSub.classList.add('ready');
    else btnSub.classList.remove('ready');
  },

  submitAnswer() {
    const btnSub = document.getElementById('btn-submit');
    
    if (btnSub.innerText === 'Tiếp theo') {
      this.backToGrid();
      return;
    }

    const data = db[this.currentIdx];
    let isCorrect = false;

    // --- XỬ LÝ MCQ ---
    if (data.type === 'mcq') {
      isCorrect = (this.tempMcq === data.correct);
      const opts = document.querySelectorAll('.mcq-btn');
      
      if (isCorrect) {
        opts[this.tempMcq].classList.add('res-correct');
        this.status[this.currentIdx] = true;
        this.toNextState(true);
      } else {
        opts[this.tempMcq].classList.add('res-wrong');
        this.status[this.currentIdx] = false;
        
        const btnRev = document.getElementById('btn-reveal');
        btnRev.style.display = 'block';
        btnRev.onclick = () => {
          opts[data.correct].classList.add('res-correct');
          btnRev.style.display = 'none';
          this.toNextState(false);
        };
        btnSub.style.display = 'none';
      }
    }
    
    // --- XỬ LÝ CLUSTER ---
    else {
      let allRight = true;
      data.items.forEach((item, i) => {
        if (item.val !== this.tempCluster[i]) allRight = false;
      });

      if (allRight) {
        document.querySelectorAll('.cluster-row').forEach(r => r.classList.add('row-correct'));
        this.status[this.currentIdx] = true;
        this.toNextState(true);
      } else {
        document.querySelectorAll('.cluster-row').forEach(r => r.classList.add('row-wrong'));
        this.status[this.currentIdx] = false;

        const btnRev = document.getElementById('btn-reveal');
        btnRev.style.display = 'block';
        btnRev.onclick = () => {
           data.items.forEach((item, i) => {
             const row = document.getElementById(`c-row-${i}`);
             row.classList.remove('row-wrong'); 
             
             const hint = document.getElementById(`hint-${i}`);
             hint.style.display = 'block';
             hint.style.color = 'var(--red-primary)';
             hint.innerText = `➥ Đáp án: ${item.val ? 'Đúng' : 'Sai'}`;
             
             // Mờ nút đi
             document.getElementById(`btn-sai-${i}`).style.opacity = '0.3';
             document.getElementById(`btn-dung-${i}`).style.opacity = '0.3';
             
             // Sáng nút đúng lên
             if(item.val) document.getElementById(`btn-dung-${i}`).style.opacity = '1';
             else document.getElementById(`btn-sai-${i}`).style.opacity = '1';
           });
           
           btnRev.style.display = 'none';
           this.toNextState(false);
        };
        btnSub.style.display = 'none';
      }
    }
  },

  toNextState(wasCorrect) {
    const btnSub = document.getElementById('btn-submit');
    btnSub.style.display = 'block';
    btnSub.innerText = 'Tiếp theo';
    if(wasCorrect) btnSub.style.background = 'var(--green)';
    else btnSub.style.background = 'var(--text-color)';
  }
};
</script>
</body>
</html>
